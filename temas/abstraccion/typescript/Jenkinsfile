pipeline {
    agent any

    stages {
        stage('Clonar') {
            steps {
                echo '--- Clonando el repositorio ---'
                checkout scm
            }
        }

        stage('Construir contenedor') {
            steps {
                echo '--- Construyendo la imagen Docker del proyecto ---'
                dir('temas/abstraccion/typescript') {
                    script {
                        sh 'docker build -t abstraccion-typescript .'
                    }
                }
            }
        }

        stage('Pruebas') {
            steps {
                echo '--- Ejecutando pruebas dentro del contenedor ---'
                script {
                    sh 'docker run --rm abstraccion-typescript npm run test'
                }
            }
        }

        stage('Ejecutar aplicación') {
            steps {
                echo '--- Ejecutando la aplicación final ---'
                script {
                    sh 'docker run --rm abstraccion-typescript'
                }
            }
        }
    }

    post {
        always {
            echo '--- Pipeline finalizado. Limpiando contenedores colgados (si los hubiera) ---'
            sh 'docker ps -aq --filter status=exited | xargs --no-run-if-empty docker rm || true'
        }
    }
}
